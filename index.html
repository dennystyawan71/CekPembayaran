<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cek Pembayaran Siswa</title>
  <style>
    :root {
      --accent: #1e90ff;
      --muted: #666;
    }
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 24px;
      color: #222;
      background: #f7f9fc;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 12px;
      font-weight: 600;
    }
    p.lead {
      margin: 0 0 20px;
      color: var(--muted);
    }
    .card {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 18px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.03);
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-width: 160px;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
    button.secondary {
      background: #f3f6fb;
      color: #074a8a;
    }
    #hasil {
      margin-top: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #f0f0f0;
      text-align: left;
    }
    th {
      background: #fafafa;
      color: #333;
      width: 40%;
    }
    .muted {
      color: var(--muted);
      font-size: 14px;
    }
    .error {
      color: #b00020;
      font-weight: 500;
    }
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0, 0, 0, 0.08);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hint {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
    @media (max-width: 600px) {
      .row { flex-direction: column; align-items: stretch; }
      button { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Cek Pembayaran Siswa</h1>
    <p class="lead">
      Masukkan <strong>NISN</strong> atau <strong>Nama</strong>, lalu klik "Cek".
    </p>

    <div class="card">
      <div class="row">
        <input id="q" type="text" placeholder="Masukkan NISN atau Nama (contoh: 171437 atau Denny)" />
        <button id="btn" onclick="cek()">Cek</button>
        <button class="secondary" onclick="resetAll()">Reset</button>
      </div>

      <div id="hasil" aria-live="polite"></div>

      <p class="hint">
        <strong>Petunjuk:</strong> data diambil langsung dari Google Spreadsheet kamu.
      </p>
    </div>
  </div>

  <script>
    /********* CONFIG *********/
    const API_URL = "https://script.google.com/macros/s/AKfycbxPdZcbzgwjYXkK4IAq-MRCyhYZ6TWlN-p0rdRSklB80pTCDJXSXK-jjuha4lgkUNq0Eg/exec";
    const FETCH_TIMEOUT = 12000;

    /********* UTIL *********/
    function el(id) { return document.getElementById(id); }

    function fmtCurrency(x) {
      if (x === null || x === undefined || x === "") return "-";
      const num = Number(String(x).replace(/[^0-9\-\.\,]/g, '').replace(/,/g, ''));
      if (isNaN(num)) return x;
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"'=\/]/g, function(s) {
        return ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;'
        })[s];
      });
    }

    function showLoading() {
      el('hasil').innerHTML = '<div class="muted"><span class="spinner"></span> Mencari data...</div>';
    }

    function showError(msg) {
      el('hasil').innerHTML = `<p class="error">âš  ${escapeHtml(msg)}</p>`;
    }

    function renderTable(data) {
      const nama = data.Nama || data.nama || '-';
      const nisn = data.NISN || data.nisn || '-';
      const tunggakan = data.Tunggakan || data.tunggakan || '-';
      const sudah = data["Sudah Bayar"] || data.sudah || '-';
      const sisa = data["Sisa Tunggakan"] || data.sisa || '-';

      el('hasil').innerHTML = `
        <table>
          <tr><th>Nama</th><td>${escapeHtml(nama)}</td></tr>
          <tr><th>NISN</th><td>${escapeHtml(nisn)}</td></tr>
          <tr><th>Tunggakan Baju</th><td>${fmtCurrency(tunggakan)}</td></tr>
          <tr><th>Sudah Dibayar</th><td>${fmtCurrency(sudah)}</td></tr>
          <tr><th>Sisa Tunggakan</th><td>${fmtCurrency(sisa)}</td></tr>
        </table>
      `;
    }

    async function cek() {
      const q = el('q').value.trim();
      if (!q) { showError('Silakan masukkan NISN atau Nama.'); return; }

      showLoading();

      try {
        const url = `${API_URL}?nisn=${encodeURIComponent(q)}`;
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

        const res = await fetch(url, { method: 'GET', signal: controller.signal });
        clearTimeout(timer);

        if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        const data = await res.json();

        if (data.status === "error") {
          showError(data.message || "Data tidak ditemukan");
          return;
        }

        renderTable(data);
      } catch (err) {
        console.error(err);
        showError('Gagal mengambil data: ' + err.message);
      }
    }

    function resetAll() {
      el('q').value = '';
      el('hasil').innerHTML = '';
      el('q').focus();
    }

    // Enter to submit
    el('q').addEventListener('keydown', e => {
      if (e.key === 'Enter') cek();
    });

    // Fokus input saat load
    window.addEventListener('load', () => el('q').focus());
  </script>
</body>
</html>
